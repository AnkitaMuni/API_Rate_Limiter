name: Python CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main", "develop" ] 

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install coverage flake8 pylint bandit junit-xml
      
      - name: Install Node.js dependencies
        run: npm install 

      - name: Run Flake8 (Style Linter) and generate report
        run: python -m flake8 src/ > flake8_report.txt
        env:
          PYTHONPATH: .

      - name: Run Bandit (Security Linter) and generate JSON report
        run: python -m bandit -r src/ -f json -o bandit_report.json
        env:
          PYTHONPATH: .

      - name: Run Pylint (Quality Linter & Score)
        run: python -m pylint src/ > pylint_report.txt
        env:
          PYTHONPATH: .
      
      - name: Run automated tests and generate coverage data
        run: |
          python -m coverage run --source=src/ -m unittest discover -s tests -p 'test_*.py'
        env:
          REDIS_URL: redis://localhost:6379
          PYTHONPATH: .

      - name: Generate Coverage and Test XML Reports
        run: |
          # 1. Generate Coverage HTML Report
          python -m coverage html -d coverage_html_report 

          # 2. Generate Coverage Summary Text File
          python -m coverage report > coverage_summary.txt 

          # 3. Generate Test Results XML Report (using coverage's built-in XML output)
          python -m coverage xml -o test_results.xml

      - name: Display coverage report in log (via npm script)
        run: npm run coverage-report
        env:
          PYTHONPATH: .

      - name: Create and Upload Deployment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-rate-limiter-${{ github.sha }}.zip 
          path: |
            src/
            .coveragerc
            .flake8
            pylintrc
            gunicorn.conf.py
            requirements.txt
            README.md 

            test_results.xml      
            coverage_html_report/ 
            coverage_summary.txt  
            bandit_report.json    
            pylint_report.txt     
            flake8_report.txt     
